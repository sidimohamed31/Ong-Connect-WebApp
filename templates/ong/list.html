{% extends 'base.html' %}

{% block content %}
<div class="py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold text-primary mb-1">{{ t.ngos }}</h2>
            <p class="text-muted mb-0">{{ t.ong_subtitle }}</p>
        </div>
        <a href="{{ url_for('add_ong') }}" class="btn btn-primary px-4 shadow-sm">
            <i class="bi bi-plus-lg me-2"></i>{{ t.add_new }}
        </a>
    </div>

    <!-- Stats Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 bg-primary text-white h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="bg-white bg-opacity-25 rounded-circle p-2">
                            <i class="bi bi-building fs-4"></i>
                        </div>
                        <span class="badge bg-white bg-opacity-25 rounded-pill small">{{ t.all }}</span>
                    </div>
                    <h2 id="stat-total" class="fw-bold mb-0">0</h2>
                    <p class="mb-0 opacity-75 small">{{ t.registered_orgs }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 bg-success text-white h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="bg-white bg-opacity-25 rounded-circle p-2">
                            <i class="bi bi-check-circle fs-4"></i>
                        </div>
                        <span class="badge bg-white bg-opacity-25 rounded-pill small">{{ t.active }}</span>
                    </div>
                    <h2 id="stat-valid" class="fw-bold mb-0">0</h2>
                    <p class="mb-0 opacity-75 small">{{ t.validated_ongs }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 bg-warning text-dark h-100">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="bg-dark bg-opacity-10 rounded-circle p-2">
                            <i class="bi bi-clock-history fs-4"></i>
                        </div>
                        <span class="badge bg-dark bg-opacity-10 rounded-pill small">{{ t.enattente }}</span>
                    </div>
                    <h2 id="stat-pending" class="fw-bold mb-0">0</h2>
                    <p class="mb-0 opacity-75 small">{{ t.verification_req }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm rounded-4 bg-white h-100 p-2">
                <div class="card-body d-flex flex-column justify-content-center">
                    <label class="form-label small text-muted text-uppercase fw-bold mb-2">{{ t.categories }}</label>
                    <select id="filter-category" class="form-select bg-light border-0 form-select-sm mb-3">
                        <option value="">{{ t.all }}</option>
                        {% for cat in filter_categories %}
                        <option value="{{ cat }}">{{ cat }}</option>
                        {% endfor %}
                    </select>
                    <label class="form-label small text-muted text-uppercase fw-bold mb-2">{{ t.status }}</label>
                    <select id="filter-status" class="form-select bg-light border-0 form-select-sm">
                        <option value="">{{ t.all }}</option>
                        <option value="validé">{{ t.validé }}</option>
                        <option value="enattente">{{ t.enattente }}</option>
                        <option value="rejetée">{{ t.rejetée }}</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-5">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold mb-0"><i class="bi bi-bar-chart-fill text-primary me-2"></i>{{ t.sector_impact }}
                    </h6>
                    <button id="reset-filters" class="btn btn-sm btn-link text-decoration-none">{{ t.reset_filters
                        }}</button>
                </div>
                <div class="card-body p-4">
                    <canvas id="categoryChart" style="min-height: 350px;"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 h-100 text-center">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="fw-bold mb-0">{{ t.validation_state }}</h6>
                </div>
                <div class="card-body p-4 d-flex flex-column justify-content-center align-items-center">
                    <div style="width: 100%; max-width: 250px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Table Section -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-end mb-3">
                <h5 class="fw-bold mb-0"><i class="bi bi-list-stars me-2 text-primary"></i>{{ t.detailed_registry }}
                </h5>
                <span class="text-muted small">{{ t.total_ongs }}: {{ ngos|length }}</span>
            </div>
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 border-0">{{ t.ngos }}</th>
                                <th class="border-0">{{ t.contact }}</th>
                                <th class="border-0">{{ t.domain }}</th>
                                <th class="border-0">{{ t.status }}</th>
                                <th class="text-end pe-4 border-0">{{ t.actions }}</th>
                            </tr>
                        </thead>
                        <tbody id="ong-table-body">
                            {% for ong in ngos %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        {% if ong.logo_url %}
                                        <img src="{{ url_for('static', filename=ong.logo_url) }}"
                                            class="rounded-circle me-3 border"
                                            style="width: 40px; height: 40px; object-fit: cover;">
                                        {% else %}
                                        <div class="rounded-circle me-3 bg-light d-flex align-items-center justify-content-center border"
                                            style="width: 40px; height: 40px;">
                                            <i class="bi bi-building text-muted"></i>
                                        </div>
                                        {% endif %}
                                        <div>
                                            <a href="{{ url_for('detail_ong', id=ong.id_ong) }}"
                                                class="text-dark fw-bold text-decoration-none hover-primary d-block">{{
                                                ong.nom_ong }}</a>
                                            <span class="text-muted small">ID: #{{ ong.id_ong }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="small fw-semibold text-dark">{{ ong.email }}</div>
                                    <div class="small text-muted">{{ ong.telephone }}</div>
                                </td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if ong.domaine_intervation %}
                                        {% for domain in ong.domaine_intervation.split(',') %}
                                        <span
                                            class="badge border border-primary-subtle text-primary bg-primary-subtle bg-opacity-10 px-2 py-1 rounded-pill small fw-normal">
                                            {{ t.get(domain.strip(), domain.strip()) }}
                                        </span>
                                        {% endfor %}
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    {% if ong.statut_de_validation == 'validé' %}
                                    <span
                                        class="badge bg-success bg-opacity-10 text-success border-0 px-3 py-2 rounded-pill small">{{
                                        t.validé }}</span>
                                    {% elif ong.statut_de_validation == 'rejetée' %}
                                    <span
                                        class="badge bg-danger bg-opacity-10 text-danger border-0 px-3 py-2 rounded-pill small">{{
                                        t.rejetée }}</span>
                                    {% else %}
                                    <span
                                        class="badge bg-warning bg-opacity-10 text-warning border-0 px-3 py-2 rounded-pill small">{{
                                        t.enattente }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-end pe-4">
                                    <div class="d-flex justify-content-end gap-2">
                                        {% if ong.statut_de_validation != 'validé' %}
                                        <button
                                            onclick="openAdminAuthModal('{{ url_for('admin_ong_action', action='validate', id=ong.id_ong) }}')"
                                            class="btn btn-sm btn-light text-success rounded-circle"
                                            data-bs-toggle="tooltip" title="{{ t.validé }}">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                        {% endif %}

                                        {% if ong.statut_de_validation != 'rejetée' %}
                                        <button
                                            onclick="openAdminAuthModal('{{ url_for('admin_ong_action', action='reject', id=ong.id_ong) }}')"
                                            class="btn btn-sm btn-light text-danger rounded-circle"
                                            data-bs-toggle="tooltip" title="{{ t.rejetée }}">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                        {% endif %}

                                        <button type="button" data-url="{{ url_for('edit_ong', id=ong.id_ong) }}"
                                            data-ong-id="{{ ong.id_ong }}"
                                            onclick="openPasswordModal(this.dataset.url, 'edit', parseInt(this.dataset.ongId))"
                                            class="btn btn-sm btn-light text-primary rounded-circle"
                                            data-bs-toggle="tooltip" title="{{ t.edit }}">
                                            <i class="bi bi-pencil"></i>
                                        </button>

                                        <button type="button" data-url="{{ url_for('delete_ong', id=ong.id_ong) }}"
                                            data-ong-id="{{ ong.id_ong }}"
                                            onclick="openPasswordModal(this.dataset.url, 'delete', parseInt(this.dataset.ongId))"
                                            class="btn btn-sm btn-light text-danger rounded-circle"
                                            data-bs-toggle="tooltip" title="{{ t.delete }}">
                                            <i class="bi bi-trash"></i>
                                        </button>

                                        <!-- Reset Password (Admin Only) -->
                                        {% if session.get('user_type') == 'admin' %}
                                        <form action="{{ url_for('admin_reset_password', id=ong.id_ong) }}"
                                            method="POST" class="d-inline"
                                            onsubmit="return confirm('{{ t.confirm_reset_password|default('Êtes-vous sûr ?')|replace('\'', '\\\'') }}')">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <button type="submit"
                                                class="btn btn-sm btn-light text-warning rounded-circle"
                                                data-bs-toggle="tooltip" title="Reset Password">
                                                <i class="bi bi-key-fill"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const catCtx = document.getElementById('categoryChart').getContext('2d');
        const statusCtx = document.getElementById('statusChart').getContext('2d');

        let categoryChart, statusChart;

        const filters = {
            category: document.getElementById('filter-category'),
            status: document.getElementById('filter-status')
        };

        function updateStats() {
            const params = new URLSearchParams();
            if (filters.category.value) params.append('category', filters.category.value);
            if (filters.status.value) params.append('status', filters.status.value);

            fetch(`/api/stats/ongs?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    // Update Counters
                    animateValue("stat-total", parseInt(document.getElementById('stat-total').innerText), data.total, 500);
                    animateValue("stat-valid", parseInt(document.getElementById('stat-valid').innerText), data.valid, 500);
                    animateValue("stat-pending", parseInt(document.getElementById('stat-pending').innerText), data.pending, 500);

                    // Update Charts
                    renderCategoryChart(data.by_category);
                    renderStatusChart(data.by_status);

                    filterTable();
                });
        }

        function filterTable() {
            const catValue = filters.category.value.toLowerCase();
            const statValue = filters.status.value.toLowerCase();
            const rows = document.querySelectorAll('#ong-table-body tr');

            rows.forEach(row => {
                const rowCat = row.cells[2].innerText.toLowerCase();
                const rowHTML = row.innerHTML.toLowerCase();

                const matchCat = !catValue || rowCat.includes(catValue);
                const matchStat = !statValue || rowHTML.includes(statValue);

                row.style.display = (matchCat && matchStat) ? '' : 'none';
            });
        }

        function renderCategoryChart(data) {
            const labels = data.map(item => item.label);
            const values = data.map(item => item.value);

            if (categoryChart) {
                categoryChart.data.labels = labels;
                categoryChart.data.datasets[0].data = values;
                categoryChart.update();
            } else {
                categoryChart = new Chart(catCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '{{ t.ngos }}',
                            data: values,
                            backgroundColor: 'rgba(13, 110, 253, 0.7)',
                            borderRadius: 10,
                            hoverBackgroundColor: 'rgba(13, 110, 253, 1)'
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { backgroundColor: '#1e293b', padding: 12 }
                        },
                        scales: {
                            y: { grid: { display: false } },
                            x: { beginAtZero: true, grid: { borderDash: [5, 5] } }
                        }
                    }
                });
            }
        }

        function renderStatusChart(data) {
            const labels = data.map(item => item.label);
            const values = data.map(item => item.value);

            if (statusChart) {
                statusChart.data.labels = labels;
                statusChart.data.datasets[0].data = values;
                statusChart.update();
            } else {
                statusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: ['#198754', '#ffc107', '#dc3545'],
                            borderWidth: 0,
                            hoverOffset: 20
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { padding: 20, usePointStyle: true } }
                        },
                        cutout: '80%'
                    }
                });
            }
        }

        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const obj = document.getElementById(id);
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        updateStats();

        filters.category.addEventListener('change', updateStats);
        filters.status.addEventListener('change', updateStats);
        document.getElementById('reset-filters').addEventListener('click', () => {
            filters.category.value = '';
            filters.status.value = '';
            updateStats();
        });
    });
</script>
{% endblock %}