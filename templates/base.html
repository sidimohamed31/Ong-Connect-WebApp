<!DOCTYPE html>
<html lang="{{ lang }}" dir="{{ dir }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t.title }}</title>
    <!-- Bootstrap CSS -->
    {% if lang == 'ar' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    {% else %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    {% endif %}
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">
        <i class="bi bi-list"></i>
    </button>

    <!-- Sidebar Backdrop (overlay) -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Collapsible Sidebar -->
    <nav class="navbar sidebar-hidden" id="sidebar">
        <div class="container">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <a class="navbar-brand" href="{{ url_for('index') }}">
                    <i class="bi bi-globe2"></i>
                    <span>{{ t.title }}</span>
                </a>
                <button class="sidebar-close" id="sidebarClose" aria-label="Close Sidebar">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <!-- Navigation Menu -->
            <div class="navbar-collapse">
                <div class="nav-vertical-wrapper">
                    <ul class="navbar-nav">
                        <!-- Home / Accueil Link (Context Aware) -->
                        <li class="nav-item">
                            <a class="nav-link"
                                href="{% if session.get('user_type') == 'ong' %}{{ url_for('ong_profile') }}{% else %}{{ url_for('public_dashboard') }}{% endif %}">
                                <i class="bi bi-house-door-fill"></i>
                                <span>{{ t.get('home', 'Accueil' if lang == 'fr' else 'الرئيسية') }}</span>
                            </a>
                        </li>

                        <!-- Social Cases for Everyone -->
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('public_dashboard') }}">
                                <i class="bi bi-heart-fill"></i>
                                <span>{{ t.social_cases }}</span>
                            </a>
                        </li>

                        <!-- Beneficiaries for Visitors -->
                        {% if session.get('user_type') != 'ong' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('public_beneficiaries') }}">
                                <i class="bi bi-people-fill"></i>
                                <span>{{ t.beneficiaries }}</span>
                            </a>
                        </li>
                        {% endif %}

                        <!-- Dashboard for ONGs -->
                        {% if session.get('user_type') == 'ong' %}
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('admin_dashboard') }}">
                                <i class="bi bi-speedometer2"></i>
                                <span>{{ t.dashboard }}</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{{ url_for('list_beneficiaries') }}">
                                <i class="bi bi-people-fill"></i>
                                <span>{{ t.beneficiaries }}</span>
                            </a>
                        </li>
                        {% endif %}
                    </ul>

                    <!-- Language & Auth Buttons -->
                    <div class="d-flex">
                        <a href="{{ url_for('set_language', lang_code='fr' if lang == 'ar' else 'ar') }}"
                            class="btn btn-light">
                            <i class="bi bi-translate"></i>
                            <span>{{ t.switch_lang }}</span>
                        </a>

                        {% if session.get('user_type') %}
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-light">
                            <i class="bi bi-box-arrow-right"></i>
                            <span>{{ t.logout }}</span>
                        </a>
                        {% else %}
                        <a href="{{ url_for('ong_login') }}" class="btn btn-outline-light">
                            <i class="bi bi-box-arrow-in-right"></i>
                            <span>{{ t.connect }}</span>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="text-center mt-5 py-3 text-muted border-top">
        &copy; {{ t.title }} 2025 | <a href="{{ url_for('admin_login') }}"
            class="text-decoration-none text-muted small">Admin</a>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Sidebar Toggle Script -->
    <script>
        // Sidebar elements
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarClose = document.getElementById('sidebarClose');
        const sidebarBackdrop = document.getElementById('sidebarBackdrop');

        // Toggle sidebar
        function openSidebar() {
            sidebar.classList.remove('sidebar-hidden');
            sidebarBackdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSidebar() {
            sidebar.classList.add('sidebar-hidden');
            sidebarBackdrop.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Event listeners
        sidebarToggle.addEventListener('click', openSidebar);
        sidebarClose.addEventListener('click', closeSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);

        // Close sidebar when clicking a nav link
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                setTimeout(closeSidebar, 200);
            });
        });

        // Close sidebar on ESC key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !sidebar.classList.contains('sidebar-hidden')) {
                closeSidebar();
            }
        });
    </script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script>
        const confirmDeleteText = "{{ t.confirm_delete }}";
    </script>


    <!-- Password Verification Modal -->
    <div class="modal fade" id="passwordModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t.get('security_check', 'Vérification de sécurité') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>{{ t.get('enter_ong_password', "Veuillez entrer le mot de passe de l'ONG pour continuer.") }}</p>
                    <input type="password" id="actionPassword" class="form-control" placeholder="{{ t.password }}">
                    <input type="hidden" id="targetUrl">
                    <input type="hidden" id="actionType"> <!-- 'edit' or 'delete' -->
                    <input type="hidden" id="targetOngId">
                    <div id="passwordError" class="text-danger mt-2 small d-none">Mot de passe incorrect</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel }}</button>
                    <button type="button" class="btn btn-primary" onclick="submitPasswordAction()">{{ t.get('confirm',
                        'Confirmer') }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Authentication Modal -->
    <div class="modal fade" id="adminAuthModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ t.get('admin_verification', 'Vérification Administrateur') }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>{{ t.get('enter_admin_creds', "Veuillez entrer vos identifiants d'administrateur.") }}</p>
                    <div class="mb-3">
                        <label for="adminEmail" class="form-label">{{ t.email }}</label>
                        <input type="email" id="adminEmail" class="form-control" placeholder="{{ t.email }}">
                    </div>
                    <div class="mb-3">
                        <label for="adminPassword" class="form-label">{{ t.password }}</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="{{ t.password }}">
                    </div>
                    <input type="hidden" id="adminTargetUrl">
                    <input type="hidden" id="adminActionType">
                    <div id="adminAuthError" class="text-danger mt-2 small d-none">Identifiants incorrects</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ t.cancel }}</button>
                    <button type="button" class="btn btn-primary" onclick="submitAdminAction()">{{ t.get('confirm',
                        'Confirmer') }}</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Hidden form for POST requests (Delete/Admin Action) -->
    <form id="deleteForm" method="POST" style="display:none;">
        <input type="hidden" name="password" id="deletePassword">
    </form>

    <!-- Hidden form for Admin POST requests -->
    <form id="adminActionForm" method="POST" style="display:none;">
        <input type="hidden" name="email" id="formAdminEmail">
        <input type="hidden" name="password" id="formAdminPassword">
    </form>

    <script>
        const passwordModal = new bootstrap.Modal(document.getElementById('passwordModal'));
        const adminAuthModal = new bootstrap.Modal(document.getElementById('adminAuthModal'));

        function openPasswordModal(url, type, ongId) {
            document.getElementById('targetUrl').value = url;
            document.getElementById('actionType').value = type;
            document.getElementById('targetOngId').value = ongId;
            document.getElementById('actionPassword').value = '';
            document.getElementById('passwordError').classList.add('d-none');
            passwordModal.show();
        }

        function openAdminAuthModal(url) {
            document.getElementById('adminTargetUrl').value = url;
            document.getElementById('adminEmail').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminAuthError').classList.add('d-none');
            adminAuthModal.show();
        }

        function submitPasswordAction() {
            const password = document.getElementById('actionPassword').value;
            const url = document.getElementById('targetUrl').value;
            const type = document.getElementById('actionType').value;
            const ongId = document.getElementById('targetOngId').value;
            const errorDiv = document.getElementById('passwordError');

            if (!password) {
                errorDiv.textContent = "Mot de passe requis";
                errorDiv.classList.remove('d-none');
                return;
            }

            if (type === 'delete') {
                // For Delete: Submit the hidden form to the URL with the password
                const form = document.getElementById('deleteForm');
                form.action = url;
                document.getElementById('deletePassword').value = password;
                form.submit();
            } else if (type === 'edit') {
                // For Edit: Verify via API first, then redirect
                fetch("{{ url_for('verify_ong_password') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ong_id: ongId, password: password })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.href = url;
                        } else {
                            errorDiv.textContent = data.message || "Mot de passe incorrect";
                            errorDiv.classList.remove('d-none');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        errorDiv.textContent = "Erreur de connexion";
                        errorDiv.classList.remove('d-none');
                    });
            }
        }

        function submitAdminAction() {
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const url = document.getElementById('adminTargetUrl').value;
            const errorDiv = document.getElementById('adminAuthError');

            if (!email || !password) {
                errorDiv.textContent = "Tous les champs sont requis";
                errorDiv.classList.remove('d-none');
                return;
            }

            // Verify Admin Creds first via API
            fetch("{{ url_for('verify_admin_credentials') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email: email, password: password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // If success, we want to perform the action. 
                        // Since admin_ong_action is likely a GET link in original pattern (updated to POST or we simply redirect if GET).
                        // Original code: @app.route('/admin/action/<action>/<int:id>') which was GET.
                        // We should probably redirect to it, BUT we need to ensure the backend allows it.
                        // Ideally, we start a session OR we post these credentials to the endpoint.
                        // Given the prompt "l effet de confirmer ou refuser un ong est besoin de email et mot de passe d un admin",
                        // sending credentials TO the endpoint makes sense.

                        // Let's use the hidden form to POST to the URL with credentials
                        const form = document.getElementById('adminActionForm');
                        form.action = url;
                        document.getElementById('formAdminEmail').value = email;
                        document.getElementById('formAdminPassword').value = password;
                        form.submit();
                    } else {
                        errorDiv.textContent = "Email ou mot de passe incorrect";
                        errorDiv.classList.remove('d-none');
                    }
                })
                .catch(err => {
                    errorDiv.textContent = "Erreur de connexion";
                    errorDiv.classList.remove('d-none');
                });
        }
    </script>

</html>